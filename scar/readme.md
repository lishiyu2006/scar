## Project Structure Analysis

### (I) Core Directories

1.  **data/ Directory**
    Stores the raw experimental data required for project execution, such as expression matrices. This directory contains data for different biological samples like liver, pancreas, and peripheral blood mononuclear cells (pbmc), serving as the primary input for analysis.

2.  **interaction_data/ Directory**
    Stores external biological interaction databases used for downstream analysis. This data provides the biological context for interpreting the results from association rule mining. It includes:
    *   **ppi/**: Contains Protein-Protein Interaction network data. Used by `ppi.py` to check for enrichment of discovered gene pairs.
    *   **tf/**: Contains Transcription Factor (TF) to target gene relationship data. Used by `TF.py` to analyze regulatory interactions.
    *   **Pathway Data**: Contains pathway information from databases like Reactome. Used by `reactome.py` to investigate the role of gene pairs within specific biological pathways.

3.  **scar/ Directory**(Scar under large folder scar)
    The project's core source code package, which contains the main functional development and is the key part for implementing business logic:
    *   **engine.py**: Handles core computational logic, such as calculating support (a common metric in association rules) and other indicators, providing computational support for the association rule algorithm.
    *   **resource_manager.py**: Responsible for resource management, reasonably allocating resources required for project execution (e.g., memory, file handles) to ensure stable and efficient program operation.
    *   **input.py**: Acts as the data access layer, supporting various file formats and converting them into a matrix form that the program can directly process, thus standardizing data input.
    *   **pre_input.py**: Reads file header information to prepare for chunked data input in `input.py`, optimizing the data reading process and improving efficiency and flexibility when handling large files.
    *   **logger.py**: A logging module that records key information and error details during program execution, facilitating debugging, troubleshooting, and tracing the program's execution flow.
    *   **config.yaml**: A configuration file that stores project parameters in YAML format (e.g., calculation thresholds, file path mappings), decoupling configuration from code and allowing for flexible adjustment of runtime parameters without modifying the code.
    *   **synthetic.py**: Generates random matrices for simulated data testing (e.g., when real data is unavailable or test cases need to be expanded) to validate algorithm performance under different data distributions.

4.  **results/ Directory**
    Specifically used to store the final result files generated by association rule analysis (`main.py`). It is a centralized location for the primary outputs of the computation.

5.  **logs/, DEGs_logs/, Enrichment_logs/, ppi_logs/, TF_logs/ Directories**
    Store the execution logs for the association rule, differential gene analysis, enrichment analysis, PPI analysis, and TF analysis modules, respectively. They record the program's runtime status, key step information, and potential warnings or errors to help developers monitor operation and locate issues.

6.  **ppi_result/, reactome_results/, TF_results/, enrich_results/ Directories**
    Store the output files from the Protein-Protein Interaction (PPI) analysis, Reactome pathway analysis, Transcription Factor (TF) analysis, and GO/KEGG enrichment analysis modules, respectively.

7.  **DEG_and_results/ Directory**
    Used to store the gene list files obtained after finding the intersection between Differentially Expressed Genes (DEGs) and Association Rule (AR) results.

### (II) Analysis Modules and Workflow

This section describes each analysis script. For a step-by-step execution guide, see section (III) How to Run.

#### 1. main.py

The **entry point for association rule mining**.

-   **Functionality**: Reads single-cell expression matrix data (e.g., in .mtx format) and uses the GPU (via PyTorch) to accelerate the batch computation of co-expression association rule metrics (such as support, confidence, etc.) between gene pairs.
-   **Input**: The data path specified by `main_input_path` in `scar/config.yaml`. If the input is a .mtx file and a `cell_type.tsv` file exists in the same directory, it will automatically perform the analysis separately for each cell type. **(Note: Adjust the input path in config.yaml, e.g., `main_input_path: "data/pbmc/matrix.mtx"`)**
-   **Output**: Saves the calculated association rule tables into the directory specified by `main_output_dir`, separated by cell type if applicable (e.g., `results/pbmc/results_B_cell.csv`).

#### 2. DEGs_and_GO.py

The **entry point for differential gene expression analysis**.

-   **Functionality**: Uses the `scanpy` library to perform Differentially Expressed Gene (DEG) analysis on single-cell data.
-   **Input**: The data directory specified by `degs_data_dir` in `scar/config.yaml`. This directory must contain `matrix.mtx`, `genes.tsv`, `barcodes.tsv`, and `cell_type.tsv`. **(Note: Adjust the input path in config.yaml, e.g., `degs_data_dir: "./data/pancrease"`)**
-   **Output**: For each cell type, it filters for significantly upregulated genes (`pvals_adj < 0.05` and `logfoldchanges > 0`) and saves the gene lists as CSV files to the directory specified by `degs_output_dir`.

#### 3. DEGs_and_result.py

A script for **integrating association rules and differential genes**.

-   **Functionality**: Computes the intersection of genes from the differential expression analysis (DEGs) and the association rule analysis.
-   **Input**: `degs_file` (directory of DEG analysis results) and `assoc_rules_file` (directory of association rule analysis results). The script matches result files for the same cell type from both directories.
-   **Output**: Generates a list of common genes and saves it as a CSV file to the directory specified by `output_base_dir` (e.g., `DEG_and_results/`). This file serves as the input for the subsequent GO/KEGG analysis.

#### 4. go_and_kegg.py

The **GO and KEGG functional enrichment analysis module**.

-   **Functionality**: Performs GO (Gene Ontology) and KEGG (Kyoto Encyclopedia of Genes and Genomes) enrichment analysis on a given gene list.
-   **Input**: `input_dir` (the directory containing the intersection gene lists generated by `DEGs_and_result.py`).
-   **Output**: For each input gene list, it creates a corresponding subdirectory in `output_dir` and saves two enrichment result files: `GO_top.csv` and `KEGG_top.csv`. The code logic saves results where the "Adjusted P-value" is > 0.05.

#### 5. ppi.py

The **Protein-Protein Interaction (PPI) enrichment analysis module**.

-   **Functionality**: Tests whether the gene pairs discovered through association rule mining are significantly enriched in a known PPI database.
-   **Input**: `ppi_input_dir` (directory of association rule results), `GENE_FILE` (background gene set), `PPI_FILE` (PPI database from `interaction_data`), `PPI_NAME_FILE` (ID mapping file).
-   **Processing**: For each cell type's association rule results, it calculates the enrichment significance (p-value) in the PPI network using a hypergeometric test.
-   **Output**: Generates a summary CSV file named `ppi_enrichment_summary_{...}.csv` in the `ppi_output_dir`, which includes the number of overlapping pairs, total pairs, and the p-value for each cell type.

#### 6. reactome.py

The **Reactome pathway analysis module**.

-   **Functionality**: Compares the distribution of various association rule metrics (support, confidence, lift, etc.) across different interaction types (e.g., activation, inhibition) within the Reactome pathway database.
-   **Input**: `reactome_input_dir` (directory of association rule results), `reactome_pathway_file` (Reactome pathway database from `interaction_data`).
-   **Processing**: Integrates the association rules with Reactome data and uses a t-test to compare whether there is a significant difference between the metrics for rules within a specific interaction type versus those outside of it.
-   **Output**: Generates results for each cell type in the `reactome_output_dir`, including an integrated table, a p-value summary table, and a mean comparison table.

#### 7. TF.py

The **Transcription Factor (TF)-Target Gene analysis module**.

-   **Functionality**: Analyzes whether the gene pairs from the association rules correspond to known transcription factor (TF) to target gene relationships and compares the relevant rule metrics.
-   **Input**: `TF_input_dir` (directory of association rule results), `TF_pathway_file` (TF-target gene database from `interaction_data`). **(Note: Adjust the input path in config.yaml, e.g., `TF_input_dir: "D:/software/code/code/scar2/results"`. This should be the parent directory containing the organism-specific folders.)**
-   **Processing**: Integrates the association rules with the TF-target gene database. It uses a t-test to compare whether there are statistically significant differences in metrics (support, lift, etc.) between rules that represent a TF-target relationship and those that do not. The script includes logic for sample balancing when group sizes are highly disparate.
-   **Output**: Generates analysis results for each cell type in the `TF_output_dir`, including an integrated table and a CSV file containing the t-test p-values for all metrics.

### (III) How to Run

Follow these steps to execute the entire analysis pipeline.

#### Step 1: Environment Setup

Before running any scripts, ensure you have installed all the necessary Python libraries. Open a terminal in the project's root directory and run:


#### Step 2: Configuration

Open the `scar/config.yaml` file in a text editor. Carefully review and update all file paths to match your system's directory structure. This is a critical step to ensure the scripts can find the input data and know where to save the results.

#### Step 3: Execute the Pipeline

All the following commands must be run from the **project's root directory** (the one containing the `scar` folder). Execute them one by one in the specified order.

```bash
pip install -r requirements.txt
```

All the following commands must be run from the **project's root directory** (the one containing the `scar` folder). Execute them one by one in the specified order. 

```bash
# 1. Run Association Rule Mining
python main.py

# 2. Run Differential Gene Expression Analysis
python DEGs_and_GO.py

# 3. Integrate results from steps 1 and 2
python DEGs_and_result.py

# 4. Perform Functional Enrichment
# NOTE: This script can analyze two different sets of genes.
# To choose which set to analyze, you must modify the `input_dir` path in `scar/config.yaml`.
#   a) To analyze the direct DEG results:
#      Set `input_dir` to the output directory of DEGs_and_GO.py (e.g., the `degs_output_dir` value).
#   b) To analyze the intersected DEG + scAR results:
#      Set `input_dir` to the output directory of DEGs_and_result.py (e.g., the `output_base_dir` value).
python go_and_kegg.py

# 5. Perform downstream analysis on the association rules
# 5A. PPI Enrichment Analysis
python ppi.py

# 5B. Reactome Pathway Analysis
python reactome.py

# 5C. Transcription Factor Analysis
python TF.py
```